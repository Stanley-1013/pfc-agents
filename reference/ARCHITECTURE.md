# HAN æ¶æ§‹ç¸½è¦½

> **ç¶­è­·è€…å¿…è®€**ï¼šç†è§£ç³»çµ±è¨­è¨ˆç†å¿µï¼Œç¢ºä¿ä¿®æ”¹ä¸ç ´å£æ•´é«”æ¶æ§‹ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

### ä¸‰å±¤çœŸç›¸æ¶æ§‹ (Three-Layer Truth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SSOT Layer (Intent)                      â”‚
â”‚                      ã€Œæ‡‰è©²æ€æ¨£ã€                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - SKILL.md (Skill å…¥å£ï¼ŒæŒ‰ Heading åˆ†æ®µçµ„ç¹”é€£çµ)            â”‚
â”‚  - reference/*.md (åƒè€ƒæ–‡æª”)                                 â”‚
â”‚  - å…¶ä»–é€£çµçš„ Markdown æ–‡æª”                                  â”‚
â”‚                                                             â”‚
â”‚  Tables: project_nodes, project_edges                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Code Graph Layer (Reality)                 â”‚
â”‚                      ã€Œå¯¦éš›æ€æ¨£ã€                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - å¾ AST è§£æçš„ç¨‹å¼ç¢¼çµæ§‹                                   â”‚
â”‚  - file, class, function, interface...                      â”‚
â”‚  - imports, calls, extends, implements...                   â”‚
â”‚                                                             â”‚
â”‚  Tables: code_nodes, code_edges, file_hashes                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tests Layer (Evidence)                    â”‚
â”‚                      ã€Œè­‰æ˜æ€æ¨£ã€                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - æ¸¬è©¦çµæœ                                                  â”‚
â”‚  - è¦†è“‹ç‡å ±å‘Š                                                â”‚
â”‚  - E2E æ¸¬è©¦ç‹€æ…‹                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡çªè™•ç†åŸå‰‡

| æƒ…å¢ƒ | è™•ç†æ–¹å¼ |
|------|----------|
| SSOT èªª Xï¼ŒCode åš Y | æ¨™è¨˜ç‚ºã€Œå¯¦ä½œåå·®ã€â†’ äººé¡æ±ºç­– |
| Code æœ‰ Xï¼ŒSSOT æ²’è¨˜è¼‰ | æ¨™è¨˜ç‚ºã€Œæœªæ–‡æª”åŒ–åŠŸèƒ½ã€â†’ è£œæ–‡æª” |
| SSOT èªª Xï¼ŒTest å¤±æ•— | æ¨™è¨˜ç‚ºã€Œç ´å£æ‰¿è«¾ã€â†’ é«˜å„ªå…ˆä¿®å¾© |
| Code + Test ä¸€è‡´ï¼ŒSSOT ä¸åŒ | SSOT éæ™‚ â†’ æ›´æ–°æ–‡æª” |

---

## è³‡æ–™æµå‘

```
git pull
    â”‚
    â–¼
[post-merge hook]
    â”‚
    â–¼
[Code Graph Extractor]  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                          â”‚
    â”‚  tree-sitter AST è§£æ                    â”‚
    â”‚  TypeScript, Python, Go...               â”‚
    â”‚                                          â”‚
    â–¼                                          â–¼
[Incremental Update Engine]           [SSOT Loader]
    â”‚                                          â”‚
    â”‚  git diff æ‰¾è®Šæ›´æª”æ¡ˆ                     â”‚
    â”‚  hash æ¯”å°é¿å…é‡è¤‡                       â”‚
    â”‚                                          â”‚
    â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Local brain.db                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  code_nodes, code_edges    â† Reality Layer      â”‚
â”‚  project_nodes, project_edges â† SSOT Layer      â”‚
â”‚  long_term_memory, working_memory â† Memory      â”‚
â”‚  node_kind_registry, edge_kind_registry â† Types â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
[Agent APIs]
    â”‚
    â”œâ”€â”€ PFC: è¦åŠƒä»»å‹™ï¼Œé¸æ“‡ Branch
    â”œâ”€â”€ Executor: åŸ·è¡Œä»»å‹™
    â””â”€â”€ Critic: é©—è­‰çµæœ
```

---

## è¨­è¨ˆåŸå‰‡

### 1. é¡å‹å¯æ“´å±• (Open-Closed Principle)

**å•é¡Œ**ï¼šNode/Edge é¡å‹ä¸æ‡‰å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­ã€‚

**è§£æ³•**ï¼šä½¿ç”¨ Registry è¡¨ã€‚

```python
# æ–°å¢é¡å‹åªéœ€ INSERTï¼Œä¸æ”¹ç¨‹å¼ç¢¼
from servers.registry import register_node_kind

register_node_kind(
    kind='component',
    display_name='å…ƒä»¶',
    description='React/Vue å…ƒä»¶'
)
```

**ç›¸é—œæª”æ¡ˆ**ï¼š
- `brain/schema.sql` - `node_kind_registry`, `edge_kind_registry`
- `servers/registry.py` - API å¯¦ç¾

### 2. é»‘ç®±åŒ–è¤‡é›œåº¦ (Facade Pattern)

**å•é¡Œ**ï¼šä½¿ç”¨è€…/Agent ä¸éœ€è¦ç†è§£ç³»çµ±å…§éƒ¨ã€‚

**è§£æ³•**ï¼šæä¾›çµ±ä¸€å…¥å£ `servers/facade.py`ã€‚

```python
# ä½¿ç”¨è€…åªéœ€è¦é€™äº› API
from servers.facade import sync, status, get_context, check_drift

# ä¸éœ€è¦ç›´æ¥ import ä½éšæ¨¡çµ„
# âŒ from servers.code_graph import sync_from_directory
```

### 3. éŒ¯èª¤è¨Šæ¯å¯è¡Œå‹•

**å•é¡Œ**ï¼šéŒ¯èª¤è¨Šæ¯ä¸èƒ½åªèªªã€Œå‡ºéŒ¯äº†ã€ï¼Œè¦å‘Šè¨´ä½¿ç”¨è€…æ€éº¼ä¿®ã€‚

```python
# âŒ ä¸å¥½
raise Exception("node not found")

# âœ… å¥½
raise NodeNotFoundError(
    f"Node '{node_id}' not found.\n\n"
    f"Did you run 'han sync' after git pull?\n"
)
```

### 4. éŠœæ¥å¯é©—è­‰

**å•é¡Œ**ï¼šå„æ¨¡çµ„é–“çš„éŠœæ¥å®¹æ˜“å‡ºéŒ¯ã€‚

**è§£æ³•**ï¼š`cli/doctor.py` è¨ºæ–·æ‰€æœ‰éŠœæ¥é»ã€‚

```bash
python cli/doctor.py

# æª¢æŸ¥é …ç›®ï¼š
# - Database é€£æ¥
# - Type Registry åˆå§‹åŒ–
# - SSOT æª”æ¡ˆå­˜åœ¨
# - Server æ¨¡çµ„è¼‰å…¥
# - Code Extractor å¯ç”¨
# - Git Hooks å®‰è£
```

### 5. Agent vs Script è·è²¬åˆ†é›¢

**å•é¡Œ**ï¼šè…³æœ¬ä¸æ‡‰åšèªç¾©åˆ¤æ–·ï¼Œé‚£æ˜¯ Agent çš„å·¥ä½œã€‚

**è§£æ³•**ï¼šè…³æœ¬åªæä¾›çµæ§‹åŒ–è³‡æ–™ï¼ŒAgent åšæ™ºæ…§åˆ†æã€‚

```python
# âœ… Script è·è²¬ï¼šæä¾›è³‡æ–™
def get_drift_context(project, project_dir) -> Dict:
    """æä¾› SKILL.md å…§å®¹ã€é€£çµåˆ—è¡¨ã€Code Graph ç¯€é»ç­‰çµæ§‹åŒ–è³‡æ–™"""
    return {
        'skill_content': str,      # å®Œæ•´ SKILL.md å…§å®¹
        'skill_links': {...},      # parse_skill_links() çµæœ
        'code_nodes': [...],       # Code Graph ç¯€é»
        'code_files': [...],       # æª”æ¡ˆç¯€é»
        'code_stats': {...},       # çµ±è¨ˆè³‡è¨Š
    }

# âœ… Agent è·è²¬ï¼šèªç¾©åˆ†æ
# Drift Agent æ¥æ”¶ get_drift_context() è³‡æ–™
# åˆ¤æ–·æ–‡æª”æè¿° vs å¯¦éš›ç¨‹å¼ç¢¼çš„èªç¾©åå·®
# ç”¢å‡ºå¯è¡Œå‹•çš„åå·®å ±å‘Š
```

**ç›¸é—œæª”æ¡ˆ**ï¼š
- `servers/drift.py` - `get_drift_context()` æä¾›è³‡æ–™
- `reference/agents/drift-detector.md` - Agent åšèªç¾©åˆ†æ

---

## æ¨¡çµ„è·è²¬

| æ¨¡çµ„ | è·è²¬ | ä¾è³´ |
|------|------|------|
| `servers/facade.py` | çµ±ä¸€å…¥å£ï¼Œä¸‰å±¤æŸ¥è©¢ï¼Œå¢å¼·é©—è­‰ | æ‰€æœ‰ servers |
| `servers/drift.py` | æä¾› Drift åˆ†æè³‡æ–™ï¼ˆ`get_drift_context()`ï¼‰ï¼ŒåŸºæœ¬å­˜åœ¨æ€§æª¢æŸ¥ | ssot, code_graph, graph |
| `servers/registry.py` | é¡å‹è¨»å†Šï¼Œé©—è­‰ | ç„¡ |
| `servers/code_graph.py` | Code Graph æ“ä½œï¼Œå¢é‡æ›´æ–° | registry, extractor |
| `servers/graph.py` | SSOT Graph æ“ä½œ | ç„¡ |
| `servers/ssot.py` | SKILL.md è§£æï¼ˆå‹•æ…‹åˆ†æ®µï¼Œç„¡ç¡¬ç·¨ç¢¼åˆ†é¡ï¼‰ | ç„¡ |
| `servers/memory.py` | è¨˜æ†¶æ“ä½œ | ç„¡ |
| `servers/tasks.py` | ä»»å‹™ç®¡ç† | ç„¡ |
| `tools/code_graph_extractor/` | AST è§£æ | ç„¡ |
| `cli/doctor.py` | ç³»çµ±è¨ºæ–· | æ‰€æœ‰ servers |

---

## å¦‚ä½•æ–°å¢åŠŸèƒ½

### æ–°å¢ Node é¡å‹

1. åœ¨ `registry.py` çš„ `DEFAULT_NODE_KINDS` æ–°å¢ï¼ˆæˆ–ç›´æ¥å‘¼å« APIï¼‰
2. å®Œæˆ

```python
# æ–¹å¼ 1ï¼šä¿®æ”¹é è¨­åˆ—è¡¨
DEFAULT_NODE_KINDS.append(
    ('component', 'å…ƒä»¶', 'React/Vue å…ƒä»¶', 'ğŸ§©', '#42A5F5', 'ast')
)

# æ–¹å¼ 2ï¼šå‹•æ…‹è¨»å†Š
register_node_kind('component', 'å…ƒä»¶', 'React/Vue å…ƒä»¶')
```

### æ–°å¢ Edge é¡å‹

åŒä¸Šï¼Œä¿®æ”¹ `DEFAULT_EDGE_KINDS` æˆ–å‘¼å« `register_edge_kind()`ã€‚

### æ–°å¢èªè¨€æ”¯æ´

1. åœ¨ `tools/code_graph_extractor/extractor.py` æ–°å¢ï¼š
   - `SUPPORTED_EXTENSIONS` æ˜ å°„
   - `RegexExtractor.extract_{language}()` æ–¹æ³•

2. ï¼ˆå¯é¸ï¼‰æ•´åˆ Tree-sitter èªè¨€ç¶å®šä»¥æé«˜æº–ç¢ºåº¦ã€‚

### æ–°å¢ Agent

1. åœ¨ `agents/` æ–°å¢ `.md` æª”æ¡ˆ
2. éµå¾ªç¾æœ‰ agent æ ¼å¼ï¼ˆYAML frontmatter + Markdownï¼‰
3. ä½¿ç”¨ `servers/` API èˆ‡ç³»çµ±äº’å‹•

---

## ç›®éŒ„çµæ§‹

```
~/.claude/han/                # Skill æ ¹ç›®éŒ„
â”œâ”€â”€ SKILL.md                 # Skill å…¥å£ï¼ˆæŒ‰ Heading çµ„ç¹”é€£çµï¼‰
â”œâ”€â”€ reference/               # åƒè€ƒæ–‡æª”
â”‚   â”œâ”€â”€ ARCHITECTURE.md      # æœ¬æ–‡æª”
â”‚   â”œâ”€â”€ API_REFERENCE.md     # API åƒè€ƒ
â”‚   â”œâ”€â”€ WORKFLOW_GUIDE.md    # å·¥ä½œæµæŒ‡å—
â”‚   â”œâ”€â”€ MEMORY_GUIDE.md      # è¨˜æ†¶ç®¡ç†æŒ‡å—
â”‚   â”œâ”€â”€ GRAPH_GUIDE.md       # Graph ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ TROUBLESHOOTING.md   # å•é¡Œæ’è§£
â”‚   â””â”€â”€ agents/              # Agent å®šç¾©
â”‚       â”œâ”€â”€ pfc.md           # è¦åŠƒè€…ï¼ˆä¸‰å±¤æŸ¥è©¢ï¼‰
â”‚       â”œâ”€â”€ executor.md      # åŸ·è¡Œè€…
â”‚       â”œâ”€â”€ critic.md        # é©—è­‰è€…ï¼ˆGraph å¢å¼·ï¼‰
â”‚       â”œâ”€â”€ researcher.md    # ç ”ç©¶è€…
â”‚       â”œâ”€â”€ memory.md        # è¨˜æ†¶ç®¡ç†
â”‚       â””â”€â”€ drift-detector.md # åå·®åµæ¸¬ï¼ˆèªç¾©åˆ†æï¼‰
â”œâ”€â”€ brain/
â”‚   â”œâ”€â”€ brain.db             # SQLite è³‡æ–™åº«
â”‚   â””â”€â”€ schema.sql           # è³‡æ–™åº« Schema
â”œâ”€â”€ servers/                 # æœå‹™å±¤
â”‚   â”œâ”€â”€ facade.py            # çµ±ä¸€å…¥å£ â­ï¼ˆä¸‰å±¤æŸ¥è©¢ã€å¢å¼·é©—è­‰ï¼‰
â”‚   â”œâ”€â”€ drift.py             # Drift è³‡æ–™æä¾›ï¼ˆget_drift_contextï¼‰
â”‚   â”œâ”€â”€ registry.py          # é¡å‹è¨»å†Š
â”‚   â”œâ”€â”€ code_graph.py        # Code Graph
â”‚   â”œâ”€â”€ graph.py             # SSOT Graph
â”‚   â”œâ”€â”€ ssot.py              # SKILL.md è§£æ
â”‚   â”œâ”€â”€ memory.py            # è¨˜æ†¶æ“ä½œ
â”‚   â””â”€â”€ tasks.py             # ä»»å‹™ç®¡ç†
â”œâ”€â”€ tools/
â”‚   â””â”€â”€ code_graph_extractor/  # AST æå–å·¥å…·
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ extractor.py
â”œâ”€â”€ cli/                     # å‘½ä»¤åˆ—å·¥å…·
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ doctor.py            # ç³»çµ±è¨ºæ–·
â””â”€â”€ scripts/                 # è¼”åŠ©è…³æœ¬
```

---

## å¸¸è¦‹å•é¡Œ

### Q: ç‚ºä»€éº¼ä¸ç”¨ä¸­å¤®è³‡æ–™åº«ï¼Ÿ

**A**: Git æœ¬èº«å·²æ˜¯å»ä¸­å¿ƒåŒ–åŒæ­¥çš„æˆç†Ÿè§£æ±ºæ–¹æ¡ˆã€‚æ¯å€‹äºº `git pull` å¾Œåœ¨æœ¬åœ°å»ºæ§‹ Code Graphï¼Œçµæœä¸€è‡´ä¸”ç„¡éœ€é¡å¤–åŸºç¤è¨­æ–½ã€‚

### Q: ç‚ºä»€éº¼ Code Graph å’Œ SSOT Graph åˆ†é–‹ï¼Ÿ

**A**: å®ƒå€‘ä»£è¡¨ä¸åŒçš„çœŸç›¸å±¤ï¼š
- SSOT = æ„åœ–ï¼ˆæ‡‰è©²æ€æ¨£ï¼‰
- Code Graph = ç¾å¯¦ï¼ˆå¯¦éš›æ€æ¨£ï¼‰

åˆ†é–‹å­˜æ”¾å¯ä»¥åµæ¸¬ã€Œå¯¦ä½œåå·®ã€ã€‚

### Q: ç‚ºä»€éº¼ç”¨ Regex è€Œä¸æ˜¯ Tree-sitterï¼Ÿ

**A**: ç›®å‰ç”¨ Regex ä½œç‚º fallbackï¼Œç„¡éœ€é¡å¤–ä¾è³´ã€‚Tree-sitter æ•´åˆæ˜¯æœªä¾†å¢å¼·é …ç›®ï¼Œå¯æä¾›æ›´æº–ç¢ºçš„è§£æã€‚

### Q: è¨˜æ†¶æœƒåŒæ­¥å—ï¼Ÿ

**A**: ä¸æœƒã€‚`long_term_memory` å’Œ `working_memory` æ˜¯å€‹äººçš„ï¼Œæ°¸ä¸åŒæ­¥ã€‚é€™ä¿è­·éš±ç§ä¸¦é¿å…è¡çªã€‚

---

## åœ˜éšŠå”ä½œæŒ‡å—

æœ¬ç³»çµ±è¨­è¨ˆæ”¯æ´å¾**å€‹äººé–‹ç™¼**å¹³æ»‘æ¼”é€²åˆ°**åœ˜éšŠå”ä½œ**ï¼Œç„¡éœ€æ›´æ›åŸºç¤è¨­æ–½ã€‚

### å€‹äººæ¨¡å¼ vs åœ˜éšŠæ¨¡å¼

| è³‡æ–™å±¤ | å€‹äººæ¨¡å¼ | åœ˜éšŠæ¨¡å¼ | èªªæ˜ |
|--------|---------|---------|------|
| **SSOT** (Markdown) | æœ¬åœ°ç·¨è¼¯ | Git åŒæ­¥ + PR å¯©æ ¸ | å”¯ä¸€éœ€è¦åŒæ­¥çš„å±¤ |
| **Code Graph** | æœ¬åœ°å»ºæ§‹ | å„è‡ªå»ºæ§‹ | ç¢ºå®šæ€§ï¼šåŒæ¨£ç¨‹å¼ç¢¼ â†’ åŒæ¨£ Graph |
| **Memory** (brain.db) | å€‹äººè³‡æ–™åº« | å€‹äººè³‡æ–™åº« | **æ°¸ä¸åŒæ­¥**ï¼Œä¿è­·éš±ç§ |
| **Task Queue** | å€‹äººä»»å‹™ | å¯é¸å…±äº« | è¦–åœ˜éšŠéœ€æ±‚è€Œå®š |

### è³‡æ–™åŒæ­¥ç­–ç•¥

#### åŒæ­¥å±¤ï¼ˆåœ˜éšŠå…±äº«ï¼ŒGit ç‰ˆæ§ï¼‰

```
project-root/
â”œâ”€â”€ SKILL.md              # Skill å…¥å£ï¼ˆæˆ– .claude/skills/<name>/SKILL.mdï¼‰
â””â”€â”€ reference/            # åƒè€ƒæ–‡æª”
    â”œâ”€â”€ ARCHITECTURE.md
    â””â”€â”€ ...
```

**ç‚ºä»€éº¼é€™äº›åŒæ­¥ï¼Ÿ** å®ƒå€‘å®šç¾©ã€Œå°ˆæ¡ˆæ‡‰è©²æ€æ¨£ã€ï¼Œæ˜¯åœ˜éšŠå…±è­˜çš„æºé ­ã€‚

#### éš”é›¢å±¤ï¼ˆå€‹äººç§æœ‰ï¼Œä¸åŒæ­¥ï¼‰

```
brain/brain.db            # åŒ…å«ï¼š
â”œâ”€â”€ long_term_memory      # å€‹äººå­¸ç¿’ã€åå¥½
â”œâ”€â”€ working_memory        # ç•¶å‰å·¥ä½œç‹€æ…‹
â””â”€â”€ task_queue            # å€‹äººä»»å‹™ï¼ˆé™¤éé¸æ“‡å…±äº«ï¼‰
```

**ç‚ºä»€éº¼éš”é›¢ï¼Ÿ**
1. **éš±ç§ä¿è­·**ï¼šå­¸ç¿’ç´€éŒ„å¯èƒ½åŒ…å«æ•æ„Ÿè³‡è¨Š
2. **é¿å…è¡çª**ï¼šæ¯äººçš„å·¥ä½œè¨˜æ†¶æœƒé »ç¹è®Šå‹•
3. **ç°¡åŒ–æ¶æ§‹**ï¼šç„¡éœ€è™•ç†è¤‡é›œçš„è³‡æ–™åº«åˆä½µ

### è¡çªè™•ç†åŸå‰‡

| é¡å‹ | è™•ç†æ–¹å¼ | ç†ç”± |
|------|----------|------|
| SSOT è¡çª | Git merge + äººå·¥å¯©æ ¸ | æ„åœ–è®Šæ›´éœ€è¦äººé¡æ±ºç­– |
| Code Graph è¡çª | ä¸å­˜åœ¨ | å„è‡ªå¾ç¨‹å¼ç¢¼é‡å»ºï¼Œç¢ºå®šæ€§ |
| Memory è¡çª | ä¸å­˜åœ¨ | å€‹äººéš”é›¢ |

### åœ˜éšŠæ“´å±•è·¯å¾‘

#### 1ï¸âƒ£ å€‹äººé–‹ç™¼ (1 äºº)

```
ä½ çš„æ©Ÿå™¨
â”œâ”€â”€ ~/.claude/skills/han-agents/brain/brain.db     # ä½ çš„è¨˜æ†¶
â””â”€â”€ ~/your-project/brain/ssot/                # æœ¬åœ° SSOT
```

- æ‰€æœ‰è³‡æ–™åœ¨æœ¬åœ°
- ç„¡éœ€ä»»ä½•åŒæ­¥è¨­å®š

#### 2ï¸âƒ£ å°åœ˜éšŠ (2-5 äºº)

```
Git Repository (å…±äº«)
â””â”€â”€ brain/ssot/           # SSOT ç”± Git ç®¡ç†

æ¯å€‹äººçš„æ©Ÿå™¨
â””â”€â”€ ~/.claude/skills/han-agents/brain/brain.db     # å„è‡ªçš„è¨˜æ†¶
```

**é—œéµå¯¦è¸ï¼š**
- SSOT è®Šæ›´éœ€ PR å¯©æ ¸
- å®šæœŸåŸ·è¡Œ `check_drift()` åµæ¸¬åå·®
- è¨˜æ†¶ä¸è·¨äººåŒæ­¥ï¼Œä½†å¯å°å‡ºåˆ†äº«ï¼ˆå¦‚æœ€ä½³å¯¦è¸ï¼‰

#### 3ï¸âƒ£ å¤§åœ˜éšŠ (5+ äºº)

```
Git Repository (å…±äº«)
â””â”€â”€ SKILL.md              # é ‚å±¤ Skill å…¥å£
    â””â”€â”€ reference/        # æŒ‰æ¨¡çµ„æ‹†åˆ†æ–‡æª”
        â”œâ”€â”€ auth/
        â”œâ”€â”€ payment/
        â””â”€â”€ user/

å¯é¸ï¼šå…±äº« Task Server
â””â”€â”€ åœ˜éšŠä»»å‹™çœ‹æ¿ï¼ˆéœ€é¡å¤–å»ºè¨­ï¼‰
```

**é—œéµå¯¦è¸ï¼š**
- æ–‡æª”æŒ‰æ¨¡çµ„æ‹†åˆ†ï¼Œæ¸›å°‘åˆä½µè¡çª
- è€ƒæ…®è¨­ç½®å…±äº« Task Serverï¼ˆè¶…å‡ºæœ¬ç³»çµ±ç¯„åœï¼‰
- å»ºç«‹ SSOT è®Šæ›´çš„è‡ªå‹• Critic é©—è­‰

### è¨­è¨ˆæ±ºç­–è¨˜éŒ„ (ADR)

| ID | æ±ºç­– | ç†ç”± |
|----|------|------|
| ADR-001 | è¨˜æ†¶ä¸åŒæ­¥ | ä¿è­·éš±ç§ã€é¿å…è¤‡é›œåˆä½µé‚è¼¯ |
| ADR-002 | Code Graph æœ¬åœ°å»ºæ§‹ | ç¢ºå®šæ€§ã€ç„¡éœ€å…±äº«åŸºç¤è¨­æ–½ |
| ADR-003 | SSOT ç”¨ Git åŒæ­¥ | æˆç†Ÿæ–¹æ¡ˆã€ç‰ˆæœ¬è¿½æº¯ã€PR å¯©æ ¸ |
| ADR-004 | SQLite è€Œéä¸­å¤® DB | é›¶é…ç½®ã€é›¢ç·šå¯ç”¨ã€è·¨å°ˆæ¡ˆå…±äº« |
| ADR-005 | SKILL.md å‹•æ…‹åˆ†æ®µ | ä¸ç¡¬ç·¨ç¢¼ç›®éŒ„åˆ†é¡ï¼Œç”± Heading è‡ªç„¶çµ„ç¹” |
| ADR-006 | Agent vs Script åˆ†é›¢ | è…³æœ¬æä¾›è³‡æ–™ã€Agent åšèªç¾©åˆ¤æ–· |

---

## Facade APIï¼ˆçµ±ä¸€å…¥å£ï¼‰

```python
from servers.facade import (
    # === PFC ä¸‰å±¤æŸ¥è©¢ï¼ˆStory 15ï¼‰===
    get_full_context,        # å–å¾—å®Œæ•´ä¸‰å±¤ contextï¼ˆSSOT + Code + Memoryï¼‰
    format_context_for_agent, # æ ¼å¼åŒ–ç‚º Agent å¯è®€çš„ Markdown

    # === Critic å¢å¼·é©—è­‰ï¼ˆStory 16ï¼‰===
    validate_with_graph,     # ä½¿ç”¨ Graph åšå¢å¼·é©—è­‰
    format_validation_report, # æ ¼å¼åŒ–é©—è­‰å ±å‘Š

    # === Drift åµæ¸¬ï¼ˆStory 17ï¼‰===
    check_drift,             # åŸºæœ¬å­˜åœ¨æ€§æª¢æŸ¥
    get_drift_context,       # å–å¾— Drift åˆ†æè³‡æ–™ï¼ˆä¾› Agent èªç¾©åˆ†æï¼‰

    # === SSOT Graph åŒæ­¥ ===
    sync_skill_graph         # åŒæ­¥ SKILL.md é€£çµåˆ° Graph
)
```

### Drift åˆ†ææ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     get_drift_context()                      â”‚
â”‚                  (servers/drift.py)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æä¾›çµæ§‹åŒ–è³‡æ–™ï¼š                                            â”‚
â”‚  - skill_content: SKILL.md å®Œæ•´å…§å®¹                         â”‚
â”‚  - skill_links: parse_skill_links() çµæœï¼ˆé€£çµ + åˆ†æ®µï¼‰     â”‚
â”‚  - code_nodes: Code Graph æ‰€æœ‰ç¯€é»                          â”‚
â”‚  - code_files: æª”æ¡ˆç¯€é»åˆ—è¡¨                                  â”‚
â”‚  - code_stats: çµ±è¨ˆè³‡è¨Š                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Drift Agent                              â”‚
â”‚              (reference/agents/drift-detector.md)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èªç¾©åˆ†æï¼š                                                  â”‚
â”‚  - åˆ¤æ–·æ–‡æª”æè¿° vs å¯¦éš›ç¨‹å¼ç¢¼çš„èªç¾©åå·®                      â”‚
â”‚  - è­˜åˆ¥æœªæ–‡æª”åŒ–çš„é‡è¦åŠŸèƒ½                                    â”‚
â”‚  - è­˜åˆ¥æ–‡æª”æè¿°ä½†æœªå¯¦ä½œçš„åŠŸèƒ½                                â”‚
â”‚  - ç”¢å‡ºå¯è¡Œå‹•çš„åå·®å ±å‘Š                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | èªªæ˜ |
|------|------|------|
| 3.0.0 | 2026-01 | è½‰å‹ç‚º Skill æ¶æ§‹ï¼ŒSKILL.md å‹•æ…‹åˆ†æ®µï¼ŒAgent vs Script åˆ†é›¢ |
| 2.1.0 | 2025-12 | Stories 15-17: ä¸‰å±¤æŸ¥è©¢ã€å¢å¼·é©—è­‰ã€Drift åµæ¸¬ |
| 2.0.0 | 2025-12 | Stories 1-14: åŸºç¤æ¶æ§‹ã€Code Graphã€Agents |
| 1.0.0 | 2025-11 | åˆç‰ˆï¼šAttention Tree æ¦‚å¿µé©—è­‰ |

### Stories å®Œæˆå°ç…§è¡¨

<details>
<summary>å±•é–‹æŸ¥çœ‹æ‰€æœ‰ Stories</summary>

| Story | åŠŸèƒ½ | å¯¦ä½œä½ç½® |
|-------|------|----------|
| **Phase 1: åŸºç¤æ¶æ§‹** | | |
| S01 | SSOT Schema | `brain/schema.sql` |
| S02 | Graph Server | `servers/graph.py` |
| S03 | SSOT Index è¼‰å…¥ | `servers/ssot.py` |
| S04 | Type Registry | `servers/registry.py` |
| S05 | Memory Server | `servers/memory.py` |
| S06 | Task Queue | `servers/tasks.py` |
| **Phase 2: Code Graph** | | |
| S07 | Extractor æ¶æ§‹ | `tools/code_graph_extractor/` |
| S08 | AST è§£æ | `extractor.py` (TS/Py/Go) |
| S09 | Code Graph Server | `servers/code_graph.py` |
| **Phase 3: Agents** | | |
| S10 | PFC Agent | `agents/pfc.md` |
| S11 | Executor Agent | `agents/executor.md` |
| S12 | Critic Agent | `agents/critic.md` |
| **Phase 4: Integration** | | |
| S13 | CLI å…¥å£ | `cli/main.py` |
| S14 | Facade API | `servers/facade.py` |
| **Phase 5: é€²éšåŠŸèƒ½** | | |
| S15 | PFC ä¸‰å±¤æŸ¥è©¢ | `facade.get_full_context()` |
| S16 | Critic Graph å¢å¼· | `facade.validate_with_graph()` |
| S17 | Drift Detector | `servers/drift.py`, `agents/drift-detector.md` |

</details>

### é©—è­‰

```bash
python scripts/verify_stories.py        # å®Œæ•´é©—è­‰
python scripts/verify_stories.py -s 15  # åªé©—è­‰ Story 15
```

---

## ç¶­è­·è€…å®ˆå‰‡

1. **ä¸è¦ç›´æ¥ä¿®æ”¹ Schema ä¸­çš„é¡å‹åˆ—è¡¨**ï¼Œä½¿ç”¨ Registry API
2. **æ–°åŠŸèƒ½å…ˆå¯«è¨ºæ–·**ï¼Œç¢ºä¿ `doctor.py` èƒ½æª¢æ¸¬å•é¡Œ
3. **éŒ¯èª¤è¨Šæ¯å¿…é ˆå¯è¡Œå‹•**ï¼Œå‘Šè¨´ä½¿ç”¨è€…æ€éº¼ä¿®
4. **ä¿æŒ Facade å±¤ç°¡æ½”**ï¼Œè¤‡é›œåº¦è—åœ¨å¯¦ä½œå±¤
5. **æ–‡æª”èˆ‡ç¨‹å¼ç¢¼åŒæ­¥æ›´æ–°**ï¼Œé¿å… SSOT åå·®
